# AI 育儿助手聊天模块 API 文档

## 目录

- [概述](#概述)
- [数据模型](#数据模型)
- [API 接口](#api接口)
  - [会话管理](#会话管理)
  - [消息交互](#消息交互)
  - [传统聊天功能](#传统聊天功能)
  - [其他功能](#其他功能)
- [错误处理](#错误处理)
- [最佳实践](#最佳实践)

## 概述

聊天模块是 AI 育儿助手的核心功能，提供了两种主要的聊天模式：

1. **传统单次聊天**：用户发送单条消息并获取 AI 回复，不保留上下文连续性
2. **基于会话的连续对话**：用户可以创建会话，在会话中进行连续对话，保持上下文连续性

聊天模块支持以下核心功能：

- 会话管理（创建、查询、更新、删除）
- 消息交互（普通方式和流式方式）
- 聊天历史记录查询
- 问题建议
- 反馈机制

## 数据模型

### 会话模型 (Conversation)

```typescript
interface Conversation {
  id: number; // 会话ID
  userId: number; // 用户ID
  childId?: number; // 关联的孩子ID（可选）
  title?: string; // 会话标题
  createdAt: Date; // 创建时间
  updatedAt: Date; // 更新时间
  isArchived: boolean; // 是否归档
  messageCount: number; // 消息数量
  latestMessage?: ChatHistory; // 最新一条消息
}
```

### 聊天记录模型 (ChatHistory)

```typescript
interface ChatHistory {
  id: number; // 聊天记录ID
  userId: number; // 用户ID
  childId?: number; // 关联的孩子ID（可选）
  conversationId?: number; // 关联的会话ID（可选）
  userMessage: string; // 用户消息
  aiResponse?: string; // AI回复
  contextSummary: string[]; // 上下文摘要
  feedback?: number; // 反馈（1为有用，-1为无用）
  requestTimestamp: Date; // 请求时间
  responseTimestamp?: Date; // 回复时间
}
```

## API 接口

### 会话管理

#### 创建新会话

**请求**：

```
POST /api/chat/conversations
```

**请求体**：

```json
{
  "title": "关于宝宝睡眠问题的咨询", // 可选，如果不提供则使用初始消息自动生成
  "childId": 1, // 可选，关联的孩子ID
  "initialMessage": "我的宝宝最近睡不好，有什么建议吗？" // 可选，首条消息
}
```

**响应**：

```json
{
  "id": "123",
  "userId": 1,
  "childId": 1,
  "title": "关于宝宝睡眠问题的咨询",
  "createdAt": "2025-05-23T08:00:00Z",
  "updatedAt": "2025-05-23T08:00:00Z",
  "isArchived": false,
  "messageCount": 1
}
```

**调用流程**：

1. 客户端发送创建会话请求
2. 服务端创建会话记录
3. 如果提供了`initialMessage`，自动发送第一条消息并获取 AI 回复
4. 如果没有提供`title`，使用初始消息的前 20 个字符自动生成标题
5. 返回创建的会话信息

**注意事项**：

- 可以创建空会话（不提供`initialMessage`），之后再发送消息
- 如果提供了`childId`，AI 回复将基于该孩子的信息进行个性化

#### 获取会话列表

**请求**：

```
GET /api/chat/conversations
```

**查询参数**：

- `childId`：（可选）筛选特定孩子的会话
- `includeArchived`：（可选）是否包含已归档会话，默认为 false
- `limit`：（可选）返回的最大记录数，默认为 10
- `offset`：（可选）分页偏移量，默认为 0

**响应**：

```json
[
  {
    "id": "123",
    "userId": 1,
    "childId": 1,
    "title": "关于宝宝睡眠问题的咨询",
    "createdAt": "2025-05-23T08:00:00Z",
    "updatedAt": "2025-05-23T08:00:00Z",
    "isArchived": false,
    "messageCount": 5,
    "latestMessage": {
      "id": "456",
      "userMessage": "谢谢，我明白了",
      "aiResponse": "不客气，如果有其他问题随时可以咨询。",
      "requestTimestamp": "2025-05-23T08:30:00Z"
    }
  }
  // 更多会话...
]
```

**调用流程**：

1. 客户端请求会话列表，可选择性地提供过滤条件
2. 服务端查询符合条件的会话列表
3. 对于每个会话，附加最新一条消息和消息总数
4. 返回会话列表，按更新时间降序排列

#### 获取会话详情

**请求**：

```
GET /api/chat/conversations/{id}
```

**路径参数**：

- `id`：会话 ID

**响应**：

```json
{
  "id": "123",
  "userId": 1,
  "childId": 1,
  "title": "关于宝宝睡眠问题的咨询",
  "createdAt": "2025-05-23T08:00:00Z",
  "updatedAt": "2025-05-23T08:30:00Z",
  "isArchived": false,
  "messageCount": 5,
  "messages": [
    {
      "id": "456",
      "userMessage": "我的宝宝最近睡不好，有什么建议吗？",
      "aiResponse": "针对宝宝睡眠问题，您可以尝试以下方法：...",
      "requestTimestamp": "2025-05-23T08:00:00Z",
      "responseTimestamp": "2025-05-23T08:00:05Z"
    }
    // 更多消息...
  ]
}
```

**调用流程**：

1. 客户端请求特定会话的详情
2. 服务端验证用户对该会话的访问权限
3. 查询会话信息及其关联的消息（默认最近 30 条）
4. 返回会话详情，包含会话基本信息和消息列表（按时间正序排列）

**注意事项**：

- 消息列表默认按时间正序排列，便于前端直接显示对话流
- 默认返回最近 30 条消息，如需更多消息可使用专门的消息历史 API

#### 更新会话

**请求**：

```
PUT /api/chat/conversations/{id}
```

**路径参数**：

- `id`：会话 ID

**请求体**：

```json
{
  "title": "新的会话标题", // 可选
  "isArchived": true // 可选，是否归档
}
```

**响应**：

```json
{
  "id": "123",
  "userId": 1,
  "childId": 1,
  "title": "新的会话标题",
  "createdAt": "2025-05-23T08:00:00Z",
  "updatedAt": "2025-05-23T09:00:00Z",
  "isArchived": true
}
```

**调用流程**：

1. 客户端发送更新会话请求
2. 服务端验证用户对该会话的访问权限
3. 更新会话信息
4. 返回更新后的会话信息

**注意事项**：

- 只能更新会话的标题和归档状态
- 归档的会话默认不会出现在会话列表中，除非明确请求包含归档会话

#### 删除会话

**请求**：

```
DELETE /api/chat/conversations/{id}
```

**路径参数**：

- `id`：会话 ID

**响应**：

```json
{
  "success": true,
  "message": "会话删除成功"
}
```

**调用流程**：

1. 客户端发送删除会话请求
2. 服务端验证用户对该会话的访问权限
3. 删除会话及其关联的所有消息
4. 返回删除结果

**注意事项**：

- 删除操作是永久性的，无法恢复
- 会级联删除该会话下的所有聊天记录

### 消息交互

#### 在会话中发送消息（普通方式）

**请求**：

```
POST /api/chat/conversations/{id}/messages
```

**路径参数**：

- `id`：会话 ID

**请求体**：

```json
{
  "message": "宝宝晚上总是醒来哭闹，怎么办？"
}
```

**响应**：

```json
{
  "id": "456",
  "userMessage": "宝宝晚上总是醒来哭闹，怎么办？",
  "aiResponse": "宝宝夜间醒来哭闹可能有多种原因：...",
  "timestamp": "2025-05-23T08:15:00Z"
}
```

**调用流程**：

1. 客户端在特定会话中发送消息
2. 服务端验证用户对该会话的访问权限
3. 处理消息并调用 AI 服务生成回复
4. 将聊天记录关联到会话，并更新会话的更新时间
5. 返回包含用户消息和 AI 回复的结果

**注意事项**：

- 如果会话关联了特定孩子，AI 回复将基于该孩子的信息进行个性化
- 普通方式适合短小的回复，对于长回复建议使用流式方式

#### 在会话中发送消息（流式方式）

**请求**：

```
GET /api/chat/conversations/{id}/stream?message=宝宝晚上总是醒来哭闹，怎么办？
```

**路径参数**：

- `id`：会话 ID

**查询参数**：

- `message`：用户消息

**响应**：
Server-Sent Events (SSE) 流，每个事件包含：

```json
{
  "data": {
    "id": "chatcmpl-123",
    "object": "chat.completion.chunk",
    "created": 1684804273,
    "model": "deepseek-ai/DeepSeek-V3",
    "choices": [
      {
        "index": 0,
        "delta": {
          "content": "宝宝"
        },
        "finish_reason": null
      }
    ]
  }
}
```

最后一个事件包含完成标记和聊天记录 ID：

```json
{
  "data": {
    "id": "chatcmpl-123",
    "object": "chat.completion.chunk",
    "created": 1684804273,
    "model": "deepseek-ai/DeepSeek-V3",
    "choices": [
      {
        "index": 0,
        "delta": {},
        "finish_reason": "stop"
      }
    ],
    "metadata": {
      "chatId": "456"
    }
  }
}
```

**调用流程**：

1. 客户端通过 SSE 连接发送消息
2. 服务端验证用户对该会话的访问权限
3. 处理消息并调用 AI 服务生成流式回复
4. 服务端以 SSE 格式流式返回 AI 回复内容
5. 流结束时，将完整的聊天记录关联到会话，并更新会话的更新时间
6. 在最后一个事件中包含聊天记录 ID，便于前端进行后续操作

**注意事项**：

- 流式响应格式兼容 OpenAI Chat API，便于前端使用现有的 OpenAI 客户端库
- 流式方式适合长回复，可以提供更好的用户体验
- 前端应正确处理流式响应，逐步显示 AI 回复内容

#### 获取会话中的消息历史

**请求**：

```
GET /api/chat/conversations/{id}/messages?limit=20&offset=0
```

**路径参数**：

- `id`：会话 ID

**查询参数**：

- `limit`：（可选）返回的最大记录数，默认为 20
- `offset`：（可选）分页偏移量，默认为 0

**响应**：

```json
[
  {
    "id": "456",
    "userMessage": "我的宝宝最近睡不好，有什么建议吗？",
    "aiResponse": "针对宝宝睡眠问题，您可以尝试以下方法：...",
    "requestTimestamp": "2025-05-23T08:00:00Z",
    "responseTimestamp": "2025-05-23T08:00:05Z"
  }
  // 更多消息...
]
```

**调用流程**：

1. 客户端请求特定会话的消息历史
2. 服务端验证用户对该会话的访问权限
3. 查询会话中的消息历史
4. 返回消息列表，按时间正序排列

**注意事项**：

- 消息列表按时间正序排列，便于前端直接显示对话流
- 使用分页参数可以加载更多历史消息

### 传统聊天功能

#### 发送聊天消息（普通方式）

**请求**：

```
POST /api/chat
```

**请求体**：

```json
{
  "message": "宝宝多大可以添加辅食？",
  "childId": 1 // 可选
}
```

**响应**：

```json
{
  "id": "789",
  "message": "一般来说，宝宝可以在4-6个月左右开始添加辅食...",
  "timestamp": "2025-05-23T10:00:00Z"
}
```

**调用流程**：

1. 客户端发送聊天请求
2. 服务端处理消息并调用 AI 服务生成回复
3. 保存聊天记录（不关联到特定会话）
4. 返回 AI 回复结果

**注意事项**：

- 传统聊天功能不保留上下文连续性，每次对话都是独立的
- 如果提供了`childId`，AI 回复将基于该孩子的信息进行个性化

#### 发送聊天消息（流式方式）

**请求**：

```
GET /api/chat/stream?message=宝宝多大可以添加辅食？&childId=1
```

**查询参数**：

- `message`：用户消息
- `childId`：（可选）关联的孩子 ID

**响应**：
Server-Sent Events (SSE) 流，格式与会话中的流式消息相同

**调用流程**：

1. 客户端通过 SSE 连接发送消息
2. 服务端处理消息并调用 AI 服务生成流式回复
3. 服务端以 SSE 格式流式返回 AI 回复内容
4. 流结束时，保存完整的聊天记录（不关联到特定会话）
5. 在最后一个事件中包含聊天记录 ID

**注意事项**：

- 传统聊天的流式 API 与会话中的流式 API 格式一致，便于前端统一处理

### 其他功能

#### 获取问题建议

**请求**：

```
GET /api/chat/suggestions?childId=1
```

**查询参数**：

- `childId`：（可选）关联的孩子 ID

**响应**：

```json
[
  "宝宝最近的睡眠情况如何？",
  "宝宝对新添加的辅食有什么反应？",
  "宝宝的语言发展达到了哪些里程碑？",
  "您最近在育儿过程中遇到了什么困难？",
  "宝宝的运动能力有哪些新的进展？"
]
```

**调用流程**：

1. 客户端请求问题建议
2. 如果指定了`childId`，服务端基于孩子信息（如月龄、性别）和历史记录生成个性化建议
3. 如果没有指定`childId`，返回通用问题建议
4. 返回问题建议列表

**注意事项**：

- 问题建议基于孩子的月龄、历史记录和日常记录生成，具有高度个性化
- 新用户会收到基础引导性问题

#### 提供聊天反馈

**请求**：

```
POST /api/chat/feedback
```

**请求体**：

```json
{
  "chatHistoryId": 123,
  "isHelpful": true
}
```

**响应**：

```json
{
  "success": true,
  "message": "反馈已保存"
}
```

**调用流程**：

1. 客户端发送反馈
2. 服务端验证用户对该聊天记录的访问权限
3. 保存反馈（1 为有用，-1 为无用）
4. 返回保存结果

**注意事项**：

- 反馈数据用于系统改进，不会立即影响 AI 回复
- 每条聊天记录只能提供一次反馈，重复提交会覆盖之前的反馈

## 错误处理

所有 API 在遇到错误时会返回适当的 HTTP 状态码和错误信息：

```json
{
  "statusCode": 404,
  "message": "会话不存在",
  "error": "Not Found"
}
```

常见错误状态码：

- `400 Bad Request`：请求参数错误
- `401 Unauthorized`：未认证或认证失败
- `403 Forbidden`：无权访问资源
- `404 Not Found`：资源不存在
- `500 Internal Server Error`：服务器内部错误

## 最佳实践

### 会话管理

1. **创建会话时提供初始消息**：这样可以自动生成会话标题并开始对话
2. **定期归档不活跃会话**：通过更新会话的`isArchived`字段为`true`
3. **使用分页参数获取更多会话**：当用户有大量会话时，使用`limit`和`offset`参数分页加载

### 消息交互

1. **优先使用流式 API**：对于长回复，流式 API 可以提供更好的用户体验
2. **处理流式响应中的错误**：检查响应中的`error`字段，适当向用户展示错误信息
3. **保存聊天记录 ID**：流式响应结束时会返回聊天记录 ID，保存它以便后续提供反馈

### 性能优化

1. **按需加载历史消息**：初始只加载最近的消息，当用户滚动查看更多历史消息时再加载
2. **缓存会话列表**：缓存会话列表并在发送新消息后更新缓存
3. **优化流式响应处理**：使用高效的流式处理库，避免内存泄漏

---

本文档详细描述了 AI 育儿助手聊天模块的 API 接口和调用流程，为前端开发人员提供了完整的参考。如有任何问题或需要进一步的说明，请联系后端开发团队。
