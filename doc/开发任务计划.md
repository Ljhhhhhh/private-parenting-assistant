# AI 聊天界面重构开发任务计划

## 📋 项目概述

基于 assistant-ui 重构现有聊天界面，分三个阶段实施，总计 6-7 周开发周期。

---

## 🎯 阶段一：基础架构搭建 (Week 1-2)

### Week 1: 核心组件开发

#### 任务 1.1: 项目结构重组 (1 天)

- [ ] **创建新的聊天模块目录结构**

  ```
  src/pages/chat/
  ├── components/           # 聊天相关组件
  │   ├── SmartChatPage.tsx        # 主页面容器
  │   ├── ChatContainer.tsx        # 聊天容器
  │   ├── ConversationSidebar.tsx  # 会话侧边栏
  │   ├── SmartChatThread.tsx      # 智能聊天线程
  │   └── enhanced/               # 增强组件
  │       ├── SmartWelcome.tsx
  │       ├── SmartComposer.tsx
  │       ├── EnhancedUserMessage.tsx
  │       └── EnhancedAssistantMessage.tsx
  ├── hooks/               # 聊天相关 hooks
  │   ├── useConversationStore.ts
  │   ├── useMessageStore.ts
  │   ├── useChatRuntime.ts
  │   └── useFeedbackHandler.ts
  ├── utils/               # 聊天工具函数
  │   ├── messageUtils.ts
  │   └── conversationUtils.ts
  └── types/               # 聊天类型定义
      └── chat.ts
  ```

- [ ] **迁移现有 Chat.tsx 为 LegacyChat.tsx**
  - 保留原有功能作为后备方案
  - 添加功能标记以便后续对比测试

#### 任务 1.2: Zustand 状态管理设置 (1 天)

- [ ] **创建会话状态管理 (useConversationStore.ts)**

  ```typescript
  interface ConversationStore {
    // 状态
    conversations: ConversationResponseDto[];
    currentConversationId: number | null;
    isLoading: boolean;
    error: string | null;

    // 操作
    loadConversations: (childId: number) => Promise<void>;
    createConversation: (data: CreateConversationDto) => Promise<number>;
    selectConversation: (id: number) => void;
    updateConversation: (
      id: number,
      data: UpdateConversationDto,
    ) => Promise<void>;
    archiveConversation: (id: number) => Promise<void>;
    deleteConversation: (id: number) => Promise<void>;
    clearError: () => void;
  }
  ```

- [ ] **创建消息状态管理 (useMessageStore.ts)**

  ```typescript
  interface MessageStore {
    // 状态
    messagesByConversation: Record<number, ChatHistoryDto[]>;
    streamingMessage: string | null;
    isStreaming: boolean;
    pendingMessages: Record<string, string>;

    // 操作
    loadMessages: (conversationId: number) => Promise<void>;
    addPendingMessage: (tempId: string, content: string) => void;
    updateStreamingMessage: (content: string) => void;
    finishMessage: (tempId: string, finalMessage: ChatHistoryDto) => void;
    clearStreaming: () => void;
  }
  ```

#### 任务 1.3: 基础路由配置 (0.5 天)

- [ ] **更新路由支持会话 ID 参数**

  ```typescript
  // src/router/index.tsx
  {
    path: '/chat',
    element: <SmartChatPage />,
  },
  {
    path: '/chat/:conversationId',
    element: <SmartChatPage />,
  }
  ```

- [ ] **创建路由 hooks**

  ```typescript
  // src/pages/chat/hooks/useRouterParams.ts
  const useRouterParams = () => {
    const { conversationId } = useParams();
    const navigate = useNavigate();

    return {
      currentConversationId: conversationId ? parseInt(conversationId) : null,
      navigateToConversation: (id: number) => navigate(`/chat/${id}`),
      navigateToNewChat: () => navigate('/chat'),
    };
  };
  ```

#### 任务 1.4: Assistant-UI Runtime 配置 (1.5 天)

- [ ] **创建聊天运行时 (useChatRuntime.ts)**

  ```typescript
  const createChatRuntime = (
    conversationId: number | null,
    childId: number,
  ) => {
    return createAISDKAdapter({
      async sendMessage(message: string) {
        if (conversationId) {
          return sendConversationMessageStream(conversationId, message);
        } else {
          return chat({ message, childId });
        }
      },

      async loadMessages() {
        if (conversationId) {
          return getConversationMessages(conversationId);
        }
        return [];
      },
    });
  };
  ```

- [ ] **集成流式响应处理**
  - 适配现有的流式 API
  - 确保与 assistant-ui 的流式接口兼容
  - 添加错误处理和重试机制

#### 任务 1.5: 基础组件开发 (2 天)

- [ ] **创建 SmartChatPage.tsx**

  - 主页面容器，管理整体布局
  - 集成响应式侧边栏
  - 处理移动端和桌面端布局差异

- [ ] **创建 ChatContainer.tsx**
  - 聊天容器组件
  - 集成 assistant-ui 的 AssistantProvider
  - 管理聊天运行时状态

### Week 2: API 集成和基础功能

#### 任务 2.1: 会话管理 API 集成 (1.5 天)

- [ ] **实现会话 CRUD 操作**

  - 集成创建会话 API
  - 实现会话列表获取
  - 添加会话更新和删除功能
  - 处理 API 错误和加载状态

- [ ] **创建会话工具函数 (conversationUtils.ts)**

  ```typescript
  export const generateConversationTitle = (firstMessage: string): string => {
    // 基于首条消息生成标题逻辑
  };

  export const formatConversationTime = (date: Date): string => {
    // 时间格式化逻辑
  };
  ```

#### 任务 2.2: 消息系统集成 (1.5 天)

- [ ] **实现消息发送和接收**

  - 集成会话内消息 API
  - 实现流式响应处理
  - 添加消息历史加载
  - 处理消息状态更新

- [ ] **创建消息工具函数 (messageUtils.ts)**

  ```typescript
  export const convertApiMessageToUI = (
    apiMessage: ChatHistoryDto,
  ): Message => {
    // API消息格式转换逻辑
  };

  export const estimateMessageHeight = (message: Message): number => {
    // 消息高度估算，用于虚拟滚动
  };
  ```

#### 任务 2.3: 错误处理系统 (1 天)

- [ ] **创建统一错误处理**

  ```typescript
  // src/pages/chat/utils/errorHandler.ts
  export const handleChatError = (error: unknown): ChatError => {
    // 统一错误处理逻辑
  };

  export const getErrorMessage = (error: ChatError): string => {
    // 用户友好的错误信息
  };
  ```

- [ ] **添加错误恢复机制**
  - 网络错误重试
  - 消息发送失败重发
  - 会话加载失败处理

#### 任务 2.4: 基础组件完善 (1 天)

- [ ] **创建 SmartChatThread.tsx**

  - 集成 assistant-ui 的 Thread 组件
  - 配置自定义组件映射
  - 实现基础的消息渲染

- [ ] **第一阶段测试和调优**
  - 基础功能集成测试
  - 性能初步优化
  - 代码质量检查

---

## 🎨 阶段二：用户体验优化 (Week 3-5)

### Week 3: 智能建议系统

#### 任务 3.1: 智能欢迎界面 (1.5 天)

- [ ] **创建 SmartWelcome.tsx**

  - 实现符合设计规范的欢迎界面
  - 集成温馨的宝宝图标和动画
  - 个性化欢迎信息（基于当前儿童信息）

- [ ] **设计规范应用**
  ```typescript
  // 严格按照设计规范的色彩系统
  const DESIGN_COLORS = {
    primary: '#FFB38A', // 温暖蜜桃
    primaryDark: '#FF9F73', // 深色变体
    primaryLight: '#FFC9A8', // 浅色变体
    background: '#FDFBF8', // 页面背景
    border: '#E0E0E0', // 边框色
    textPrimary: '#333333', // 主要文字
    textSecondary: '#666666', // 次要文字
    textTertiary: '#999999', // 辅助文字
  };
  ```

#### 任务 3.2: 智能建议卡片系统 (2 天)

- [ ] **创建 SuggestionCards.tsx**

  ```typescript
  interface SuggestionCardProps {
    suggestion: string;
    category: 'feeding' | 'sleep' | 'growth' | 'health' | 'behavior';
    onSelect: (suggestion: string) => void;
  }
  ```

- [ ] **集成后端智能建议 API**

  - 基于儿童年龄和历史记录的个性化建议
  - 实现建议分类显示
  - 添加建议点击发送功能

- [ ] **设计规范实现**
  - 卡片圆角：16px
  - 悬停效果：上移 1px + 阴影增强
  - 色彩：白色背景 + 蜜桃色边框
  - 动画：200ms 平滑过渡

#### 任务 3.3: 反馈收集系统 (1.5 天)

- [ ] **创建反馈按钮组件**

  ```typescript
  const FeedbackButton: FC<{
    type: 'helpful' | 'not-helpful';
    isActive: boolean;
    onClick: () => void;
  }> = ({ type, isActive, onClick }) => {
    // 按设计规范实现反馈按钮
  };
  ```

- [ ] **实现 useFeedbackHandler hook**
  - 集成反馈 API 调用
  - 实现 UI 状态更新
  - 添加反馈成功/失败提示

### Week 4: 会话管理系统

#### 任务 4.1: 会话侧边栏 (2 天)

- [ ] **创建 ConversationSidebar.tsx**

  - 实现响应式侧边栏（桌面端固定，移动端抽屉）
  - 会话列表滚动和虚拟化
  - 新建会话按钮

- [ ] **会话列表项设计**
  ```typescript
  const ConversationItem: FC<{
    conversation: ConversationResponseDto;
    isActive: boolean;
    onSelect: () => void;
    onArchive: () => void;
    onDelete: () => void;
  }> = ({ conversation, isActive, onSelect, onArchive, onDelete }) => {
    // 按设计规范实现列表项
  };
  ```

#### 任务 4.2: 移动端侧滑实现 (1.5 天)

- [ ] **手势交互实现**

  ```typescript
  const useSwipeGestures = () => {
    return useSwipeable({
      onSwipedLeft: () => openConversationSidebar(),
      onSwipedRight: () => closeConversationSidebar(),
      threshold: 50,
      preventDefaultTouchmoveEvent: true,
    });
  };
  ```

- [ ] **抽屉动画实现**
  - 使用 Framer Motion 实现流畅侧滑
  - 背景蒙层渐变效果
  - 支持手势跟随

#### 任务 4.3: 会话操作功能 (1.5 天)

- [ ] **会话创建流程**

  - 自动创建会话（发送第一条消息时）
  - 手动创建空会话
  - 会话标题智能生成

- [ ] **会话管理操作**
  - 会话重命名（长按编辑）
  - 会话归档和删除
  - 会话搜索功能

### Week 5: 移动端深度优化

#### 任务 5.1: 自定义消息组件 (2 天)

- [ ] **创建 EnhancedUserMessage.tsx**

  ```typescript
  // 严格按照设计规范实现用户消息
  const EnhancedUserMessage: FC = () => {
    return (
      <MessagePrimitive.Root className="flex justify-end mb-6 animate-fadeIn">
        <div className="max-w-[80%] relative group">
          <div
            className="bg-gradient-to-r from-[#FFB38A] to-[#FFC9A8] 
                          text-white rounded-xl rounded-tr-sm p-4 
                          shadow-lg shadow-[#FFB38A]/15 relative"
          >
            <MessagePrimitive.Content className="text-[15px] leading-relaxed" />
            {/* 消息尾巴设计 */}
          </div>
        </div>
      </MessagePrimitive.Root>
    );
  };
  ```

- [ ] **创建 EnhancedAssistantMessage.tsx**
  - AI 头像集成
  - 反馈按钮集成
  - 设计规范色彩应用（#FDFBF8 背景）

#### 任务 5.2: 智能输入组件 (1.5 天)

- [ ] **创建 SmartComposer.tsx**

  ```typescript
  const SmartComposer: FC = () => {
    return (
      <ComposerPrimitive.Root className="border-t border-[#E0E0E0] bg-white p-4">
        <div className="flex items-end space-x-3">
          <ComposerPrimitive.Input
            className="flex-1 min-h-[48px] py-3 px-4 
                       border border-[#E0E0E0] rounded-lg
                       focus:border-[#FFB38A] focus:ring-1 focus:ring-[#FFB38A]/20"
            placeholder="请描述宝宝的情况..."
          />
          <SmartSendButton />
        </div>
      </ComposerPrimitive.Root>
    );
  };
  ```

- [ ] **发送按钮动画优化**
  - 发送时图标旋转
  - 禁用状态平滑过渡
  - 触摸反馈优化

#### 任务 5.3: 触摸交互优化 (1.5 天)

- [ ] **长按菜单实现**

  ```typescript
  const useLongPressMenu = (messageId: string) => {
    return useLongPress(
      () => {
        showContextMenu([
          { label: '复制', action: () => copyMessage(messageId) },
          { label: '重新生成', action: () => regenerateMessage(messageId) },
          { label: '分享', action: () => shareMessage(messageId) },
        ]);
      },
      { threshold: 500 },
    );
  };
  ```

- [ ] **快捷操作实现**
  - 快速反馈手势
  - 双击消息操作
  - 滑动删除消息

---

## 🚀 阶段三：性能优化和完善 (Week 6-7)

### Week 6: 性能优化

#### 任务 6.1: 虚拟滚动实现 (2 天)

- [ ] **集成 @tanstack/react-virtual**

  ```typescript
  const VirtualMessageList: FC<VirtualMessageListProps> = ({ messages }) => {
    const { virtualItems, totalSize, scrollElementRef } = useVirtualizer({
      count: messages.length,
      getScrollElement: () => scrollElementRef.current,
      estimateSize: (index) => estimateMessageHeight(messages[index]),
      overscan: 5,
    });

    return (
      <div ref={scrollElementRef} className="message-list-container">
        {/* 虚拟滚动实现 */}
      </div>
    );
  };
  ```

- [ ] **消息高度估算优化**
  - 文本长度预估算法
  - 图片/媒体内容高度计算
  - 动态高度更新

#### 任务 6.2: 智能预加载系统 (1.5 天)

- [ ] **会话预加载策略**

  ```typescript
  const useSmartPreloading = (childId: number) => {
    useEffect(() => {
      // 预加载最近会话
      queryClient.prefetchQuery(['conversations', childId], () =>
        getConversations({ childId, limit: 10 }),
      );

      // 预加载智能建议
      queryClient.prefetchQuery(['suggestions', childId], () =>
        getChatSuggestions(childId),
      );
    }, [childId]);
  };
  ```

- [ ] **消息懒加载实现**
  - 使用 React Query 的 useInfiniteQuery
  - 上滑加载历史消息
  - 智能分页大小调整

#### 任务 6.3: 离线支持 (1.5 天)

- [ ] **离线消息队列**

  ```typescript
  const useOfflineSupport = () => {
    const [isOnline, setIsOnline] = useState(navigator.onLine);

    const queueMessage = useCallback(
      (message: string) => {
        if (!isOnline) {
          storeOfflineMessage(message);
          showOfflineNotification();
        }
      },
      [isOnline],
    );

    return { isOnline, queueMessage };
  };
  ```

- [ ] **数据同步机制**
  - IndexedDB 本地存储
  - 网络恢复时自动同步
  - 冲突解决策略

### Week 7: 测试和完善

#### 任务 7.1: 全面测试 (2 天)

- [ ] **单元测试编写**

  ```typescript
  // __tests__/components/SmartChatThread.test.tsx
  describe('SmartChatThread', () => {
    it('应该正确渲染欢迎界面', () => {
      // 测试用例
    });

    it('应该正确处理消息发送', () => {
      // 测试用例
    });
  });
  ```

- [ ] **E2E 测试**
  - 完整聊天流程测试
  - 会话管理功能测试
  - 移动端交互测试

#### 任务 7.2: 用户体验优化 (1.5 天)

- [ ] **动画效果完善**

  ```css
  /* 严格按照设计规范的动画 */
  @keyframes messageSlideIn {
    from {
      opacity: 0;
      transform: translateY(20px) scale(0.95);
    }
    to {
      opacity: 1;
      transform: translateY(0) scale(1);
    }
  }

  .message-animation {
    animation: messageSlideIn 0.4s cubic-bezier(0.25, 0.8, 0.25, 1);
  }
  ```

- [ ] **无障碍功能完善**
  - ARIA 标签完善
  - 键盘导航优化
  - 高对比度支持

#### 任务 7.3: 文档和发布准备 (1.5 天)

- [ ] **技术文档编写**

  - 组件 API 文档
  - 开发指南
  - 部署说明

- [ ] **性能监控设置**
  - 关键指标监控
  - 错误日志收集
  - 用户行为分析

---

## 📊 质量保证检查清单

### 设计规范合规检查

- [ ] **色彩系统**

  - [ ] 主色调使用温暖蜜桃 #FFB38A
  - [ ] 背景色使用暖白 #FDFBF8
  - [ ] 文字色彩层次正确（#333/#666/#999）
  - [ ] 功能色彩符合规范

- [ ] **排版系统**

  - [ ] 字号使用规范（16px 正文，12px 辅助）
  - [ ] 行高符合规范（1.5 倍行高）
  - [ ] 字重层次正确

- [ ] **组件规范**
  - [ ] 圆角统一（12px 消息，16px 卡片，8px 输入框）
  - [ ] 间距系统（8px 基础栅格）
  - [ ] 阴影效果统一

### 移动端体验检查

- [ ] **触摸交互**

  - [ ] 触摸区域最小 44px×44px
  - [ ] 手势操作流畅
  - [ ] 长按菜单响应及时

- [ ] **适配兼容**
  - [ ] 安全区域适配
  - [ ] 键盘弹起适配
  - [ ] 横屏布局优化

### 性能指标检查

- [ ] **响应性能**

  - [ ] 消息发送响应<500ms
  - [ ] 界面切换流畅 60fps
  - [ ] 长列表滚动性能良好

- [ ] **资源优化**
  - [ ] Bundle 大小增量<150KB
  - [ ] 内存使用<80MB
  - [ ] 网络请求优化

### 功能完整性检查

- [ ] **核心功能**

  - [ ] 消息发送接收正常
  - [ ] 流式响应流畅
  - [ ] 会话管理完整
  - [ ] 智能建议有效

- [ ] **边界情况**
  - [ ] 网络错误处理
  - [ ] 空状态显示
  - [ ] 长文本处理
  - [ ] 并发消息处理

---

## 🎯 交付标准

### 每周交付物

- **Week 1**: 基础组件架构 + 状态管理
- **Week 2**: API 集成 + 基础聊天功能
- **Week 3**: 智能建议系统 + 欢迎界面
- **Week 4**: 会话管理 + 侧边栏
- **Week 5**: 移动端优化 + 自定义组件
- **Week 6**: 性能优化 + 虚拟滚动
- **Week 7**: 测试完善 + 文档

### 质量标准

- **代码质量**: TypeScript 无错误，ESLint 无警告
- **测试覆盖**: 核心功能测试覆盖率 >80%
- **性能指标**: 符合设定的性能基准
- **设计一致**: 严格遵循项目设计规范
- **移动适配**: 主流设备完美适配

### 风险控制

- **向下兼容**: 保持现有功能稳定
- **渐进发布**: 每阶段可独立部署
- **回滚机制**: 保留原有 Chat.tsx 作为备用
- **监控报警**: 关键指标实时监控
